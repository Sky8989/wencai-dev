<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.1//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sftc.web.dao.mybatis.UserMapper">

    <resultMap id="User" type="com.sftc.web.model.entity.User">
        <result column="uuid" property="uuid"/>
        <association property="token" javaType="com.sftc.web.model.entity.Token">
            <result property="access_token" column="access_token"/>
        </association>
    </resultMap>

    <select id="selectUserByPhone" parameterType="java.lang.String" resultType="com.sftc.web.model.entity.User">
        SELECT *
        FROM users
        WHERE mobile = #{mobile}
    </select>

    <select id="selectUserByOpenid" parameterType="java.lang.String" resultType="com.sftc.web.model.entity.User">
        SELECT *
        FROM users
        WHERE JSON_EXTRACT(attributes, '$.c_wxopenid') = #{openId}
    </select>

    <select id="findUserByMobile" parameterType="java.lang.String" resultType="com.sftc.web.model.entity.User">
        SELECT *
        FROM users
        WHERE mobile = #{mobile}
    </select>
    <select id="selectUserByUserUUId" parameterType="string" resultType="com.sftc.web.model.entity.User">
        SELECT *
        FROM users
        WHERE uuid = #{userUUId}
    </select>

    <insert id="insertOpenid" parameterType="com.sftc.web.model.entity.User" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO users (attributes, created_at)
        VALUES
            (#{attributes}, now())
    </insert>

    <insert id="insertWithAvatarAndName" parameterType="com.sftc.web.model.entity.User" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO users (attributes, created_at, avatar, name)
        VALUES
            (#{attributes},now(), #{avatar}, #{name})
    </insert>

    <!--&lt;!&ndash;添加顺丰传过来的Merchant信息&ndash;&gt;-->
    <!--<insert id="addMerchant" parameterType="com.sftc.web.model.entity.User" useGeneratedKeys="true" keyProperty="id">-->
        <!--INSERT INTO users (mobile, user_password, open_id, created_at, avatar, uuid, name) VALUES-->
            <!--(#{mobile}, #{user_password}, #{open_id}, now(), #{avatar}, #{uuid}, #{name})-->
    <!--</insert>-->

    <select id="getUuidAndtoken" parameterType="java.lang.String" resultType="com.sftc.web.model.entity.User"
            resultMap="User">
        SELECT
            u.uuid,
            t.access_token
        FROM users u, c_token t, c_order o
        WHERE
            u.uuid = o.sender_user_uuid AND u.uuid = t.user_uuid AND o.id = #{order_id}
    </select>

    <update id="updateUserOfAvatar" parameterType="com.sftc.web.model.entity.User">
        UPDATE users
        <trim prefix="set" suffixOverrides=",">
            <if test="avatar!=null">avatar=#{avatar},</if>
            <if test="name!=null">name=#{name},</if>
        </trim>
        WHERE JSON_EXTRACT(attributes, '$.c_wxopenid') = #{openId}
    </update>

    <update id="updateUser" parameterType="com.sftc.web.model.entity.User">
        update users
        <trim prefix="set" suffixOverrides=",">
            <if test="uuid!=null">uuid=#{uuid},</if>
            <if test="mobile!=null">mobile=#{mobile},</if>
        </trim>
        WHERE uuid=#{uuid}
    </update>
</mapper>